#include "minishell.h"

// Helper: Create a new command node
t_command *new_command()
{
    t_command *cmd = malloc(sizeof(t_command));
    if (!cmd)
        return NULL;
    cmd->args = NULL;
    cmd->redir = NULL;
    cmd->next = NULL;
    return cmd;
}

// Helper: Add an argument to command
void add_argument(t_command *cmd, char *arg)
{
    int count = 0;
    while (cmd->args && cmd->args[count])
        count++;

    cmd->args = realloc(cmd->args, sizeof(char *) * (count + 2));
    cmd->args[count] = strdup(arg);
    cmd->args[count + 1] = NULL;
}

// Helper: Add a redirection to command
void add_redirection(t_command *cmd, char *type, char *file)
{
    t_redirection *redir = malloc(sizeof(t_redirection));
    if (!redir)
        return;

    redir->type = strdup(type);
    redir->file = strdup(file);
    redir->next = NULL;

    if (!cmd->redir)
        cmd->redir = redir;
    else
    {
        t_redirection *tmp = cmd->redir;
        while (tmp->next)
            tmp = tmp->next;
        tmp->next = redir;
    }
}

// Main parsing function
t_command *parse_tokens(t_token *tokens)
{
    t_command *head = new_command();
    t_command *current = head;

    while (tokens)
    {
        if (tokens->type == TOKEN_WORD)
            add_argument(current, tokens->value);
        else if (tokens->type == TOKEN_REDIRECT)
        {
            char *redir_type = tokens->value;
            tokens = tokens->next;
            if (tokens && tokens->type == TOKEN_WORD)
                add_redirection(current, redir_type, tokens->value);
        }
        else if (tokens->type == TOKEN_PIPE)
        {
            current->next = new_command();
            current = current->next;
        }
        tokens = tokens->next;
    }

    return head;
}

